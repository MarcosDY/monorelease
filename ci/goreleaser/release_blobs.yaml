version: 2

builds:
  - id: image-builds
    builder: "prebuilt"
    targets:
      - linux_multiarch
    hooks:
      pre:
          - cmd: bash -x ci/goreleaser/build.sh 
            output: true
            env:
              - VERSION={{ .Version }}
              - TARGET={{ if isEnvSet "TARGET" }}{{ .Env.TARGET }}{{ else }}//{{ .ProjectName }}{{ end }}
              - OUTPUT_PATH=tmp/{{ .ProjectName }}-release/{{ .ProjectName }}-{{ .Version }}
              # - MISE_TRUSTED_CONFIG_PATHS=/home/runner/_work/spirl/spirl
              # - MISE_YES=1
              # - MISE_LOG_LEVEL="debug"

    prebuilt:
      path: "tmp/{{ .ProjectName }}-release/{{ .ProjectName }}-{{ .Version }}"

archives:
  - id: multi-arch-images
    formats:
      - binary
    ids:
      - image-builds

# archives:
  # - id: tar-archives
    # format: tar.gz
    # name_template: >-
      # {{ .ProjectName }}-v{{ .Version }}-{{ .Os }}-{{ .Arch }}
    # # This is a hack as described by https://goreleaser.com/customization/archive/#packaging-only-the-binaries
    # files:
      # - this_does_not_exist*
    # ids:
      # - build-binaries

# checksum:
  # name_template: "{{ .ProjectName }}-v{{ .Version }}-checksums.txt"
  # algorithm: sha256
  # ids:
    # - build-binaries

